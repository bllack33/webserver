const dbConnection=require("../../config/dbConnetion"),puppeteer=require("puppeteer"),excel=require("exceljs"),fs=require("fs"),cheerio=require("cheerio"),request=require("request-promise");module.exports=(e=>{const t=dbConnection();var o=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:53.0) Gecko/20100101 Firefox/53.0","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.79 Safari/537.36 Edge/14.14393","Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 6.0; en-US","Mozilla/5.0 (iPad; CPU OS 8_4_1 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Version/8.0 Mobile/12H321 Safari/600.1.4","Lynx/2.8.8pre.4 libwww-FM/2.14 SSL-MM/1.4.1 GNUTLS/2.12.23"],a=["https://www.amazon.com/-/es/dp/","https://www.amazon.com/-/es/Nizoral-Anti-Dandruff-Shampoo-Ketoconazole-Dandruff/dp/","https://www.amazon.com/dp/","https://www.amazon.com/-/es/AmScope-Kids-M30-ABS-KT2-W-microscopio-microscopios-principiantes/dp/","https://www.amazon.com/-/es/Educational-Insights-GeoSafari-Microscope-Featuring/dp/","https://www.amazon.com/-/es/Libbey-Mixologist-9-Piece-Cocktail-Set/dp/"];e.get("/",(e,i)=>{t.query("SELECT * FROM product ORDER BY id DESC",(e,t)=>{i.render("news/news.ejs",{product:t,status:1,message:""})})}),e.post("/product",(e,r)=>{let{asin_code:n}=e.body;n=n.trim();var c=o[Math.floor(Math.random()*o.length)];const l=a[Math.floor(Math.random()*a.length)]+n;(async()=>{let e=await puppeteer.launch(),o=await e.newPage();await o.setDefaultNavigationTimeout(0),await o.setUserAgent(c),await o.goto(l,{waitUntil:"networkidle2"});await o.evaluate(()=>navigator.userAgent);try{let a=await o.evaluate(()=>{let e,t=document.querySelector("#productTitle")?document.querySelector("#productTitle").innerText:"",o=document.querySelectorAll("#main-image-container > ul li img")[0].src;var a=document.querySelectorAll("#feature-bullets ul li").length;for(i=1;i<a;++i){var r=document.querySelectorAll("#feature-bullets ul li")[i].innerText;e=r?e+"- "+r:""}let n=document.querySelector(".a-span12 #priceblock_ourprice")?document.querySelector(".a-span12 #priceblock_ourprice").innerText:"",c=document.querySelector(".a-span12 #priceblock_saleprice")?document.querySelector(".a-span12 #priceblock_saleprice").innerText:"",l=document.querySelector("#main-image-container > ul > li.image.item.itemNo1.maintain-height.selected > span > span > div > img")?document.querySelector("#main-image-container > ul > li.image.item.itemNo1.maintain-height.selected > span > span > div > img").src:"";return e=e.replace("undefined","").trim(),t=t.replace("Amazon","Tienda").trim(),c=c.replace("US$","").trim(),n=n.replace("US$","").trim(),precio_final=n||c,{title:t,description:e,imagen:o,imagen_dos:l,precio:precio_final,peso_prod:""}});await e.close(),t.query("SELECT * FROM product WHERE asin_code ='"+n+"';",(e,i)=>{i.length>0?t.query("UPDATE product SET? WHERE asin_code='"+n+"'",{name:a.title,description:a.description,img:a.imagen,img2:a.imagen_dos,cost:a.precio,shipping_weight:a.peso_prod,active:a.precio?1:0,update:new Date}):t.query("INSERT INTO product SET?",{asin_code:n,name:a.title,description:a.description,img:a.imagen,img2:a.imagen_dos,cost:a.precio,shipping_weight:a.peso_prod,active:a.precio?1:0,create:new Date})}),r.redirect("/")}catch(e){console.log(e),r.redirect("/")}})()}),e.post("/allproduct",(e,i)=>{t.query("SELECT * FROM product WHERE CAST(`update` AS DATE) < CURDATE() OR `update` IS NULL;",(e,r)=>{function n(e,o,r){setTimeout(function(){(async()=>{console.log(e);const n=a[Math.floor(Math.random()*a.length)]+e;let c=await puppeteer.launch(),l=await c.newPage();await l.setDefaultNavigationTimeout(0),await l.setUserAgent(r),await l.goto(n,{waitUntil:"networkidle2"});await l.evaluate(()=>navigator.userAgent);try{let a=await l.evaluate(()=>{let e=document.querySelector("#productTitle")?document.querySelector("#productTitle").innerText:"",t=document.querySelectorAll("#main-image-container > ul li img")[0].src;var i=document.querySelectorAll("#feature-bullets ul li").length;let a;for(o=1;o<i;++o){var r=document.querySelectorAll("#feature-bullets ul li")[o].innerText;a=r?a+"- "+r:""}let n=document.querySelector(".a-span12 #priceblock_ourprice")?document.querySelector(".a-span12 #priceblock_ourprice").innerText:"",c=document.querySelector(".a-span12 #priceblock_saleprice")?document.querySelector(".a-span12 #priceblock_saleprice").innerText:"",l=document.querySelector("#main-image-container > ul > li.image.item.itemNo1.maintain-height.selected > span > span > div > img")?document.querySelector("#main-image-container > ul > li.image.item.itemNo1.maintain-height.selected > span > span > div > img").src:"";return a=a.replace("undefined","").trim(),e=e.replace("Amazon","Tienda").trim(),c=c.replace("US$","").trim(),n=n.replace("US$","").trim(),precio_final=n||c,{title:e,description:a,imagen:t,imagen_dos:l,precio:precio_final,peso_prod:""}});console.log(a.title?"exito":"fail"),await c.close(),t.query("SELECT * FROM product WHERE asin_code ='"+e+"';",(i,o)=>{o.length>0?t.query("UPDATE product SET? WHERE asin_code='"+e+"'",{name:a.title,description:a.description,img:a.imagen,img2:a.imagen_dos,cost:a.precio,shipping_weight:a.peso_prod,active:a.precio?1:0,update:new Date}):t.query("INSERT INTO product SET?",{asin_code:e,name:a.title,description:a.description,img:a.imagen,img2:a.imagen_dos,cost:a.precio,shipping_weight:a.peso_prod,active:a.precio?1:0,create:new Date})}),i.redirect("/")}catch(e){e instanceof puppeteer.errors.TimeoutError&&console.log("no carga")}})()},15e3*o)}console.log(r.length),function(){for(var e=0;e<r.length;e++){var t=o[Math.floor(Math.random()*o.length)];n(r[e].asin_code,e,t)}}(),i.redirect("/")})}),e.post("/pendingproduct",(e,i)=>{t.query("SELECT * FROM product WHERE CAST(`update` AS DATE) < CURDATE() OR `update` IS NULL;",(e,r)=>{function n(e,o,r){setTimeout(function(){(async()=>{console.log(e);const o=a[Math.floor(Math.random()*a.length)]+e;let n=await puppeteer.launch(),c=await n.newPage();await c.setDefaultNavigationTimeout(0),await c.setUserAgent(r),await c.goto(o,{waitUntil:"networkidle2"});await c.evaluate(()=>navigator.userAgent);try{let o=await c.evaluate(()=>{let e=document.querySelector("#productTitle")?document.querySelector("#productTitle").innerText:"",t=document.querySelectorAll(".imgTagWrapper img.a-dynamic-image")?document.querySelectorAll(".imgTagWrapper img.a-dynamic-image")[0].src:"",i=document.querySelector(".a-span12 #priceblock_ourprice")?document.querySelector(".a-span12 #priceblock_ourprice").innerText:"",o=document.querySelector("#main-image-container > ul > li.image.item.itemNo1.maintain-height.selected > span > span > div > img")?document.querySelector("#main-image-container > ul > li.image.item.itemNo1.maintain-height.selected > span > span > div > img").src:"";return{title:e=e.replace("Amazon","Tienda").trim(),imagen:t,imagen_dos:o,precio:i=i.replace("US$","").trim(),peso_prod:""}});console.log(o.title?"exito":"fail"),await n.close(),t.query("SELECT * FROM product WHERE asin_code ='"+e+"';",(i,a)=>{a.length>0?t.query("UPDATE product SET? WHERE asin_code='"+e+"'",{name:o.title,img:o.imagen,img2:o.imagen_dos,cost:o.precio,shipping_weight:o.peso_prod,active:o.precio?1:0}):t.query("INSERT INTO product SET?",{asin_code:e,name:o.title,img:o.imagen,img2:o.imagen_dos,cost:o.precio,shipping_weight:o.peso_prod,active:o.precio?1:0})}),i.redirect("/")}catch(e){e instanceof puppeteer.errors.TimeoutError&&console.log("no carga")}})()},15e3*o)}!function(){for(var e=0;e<r.length;e++){var t=o[Math.floor(Math.random()*o.length)];n(r[e].asin_code,e,t)}}(),i.redirect("/")})}),e.post("/downloadexcel",(e,i)=>{t.query("SELECT * FROM product",(e,t)=>{const o=JSON.parse(JSON.stringify(t));let a=new excel.Workbook,r=a.addWorksheet("result");r.columns=[{header:"Id",key:"id",width:10},{header:"ASIN",key:"asin_code",width:30},{header:"Name",key:"name",width:30},{header:"Description",key:"description",width:30},{header:"Imagen",key:"img",width:10,width:30},{header:"Costo USD",key:"cost",width:10,width:10},{header:"Activo",key:"active",width:10,width:10},{header:"Fecha de creacion",key:"create",width:10,width:30},{header:"Fecha de actualizacion",key:"update",width:10,width:30}],r.addRows(o);const n=`${(new Date).getTime()}productos.xlsx`,c="src/app/files/";a.xlsx.writeFile(c+n).then(function(){var e=fs.createReadStream(c+n);i.writeHead(200,{"Content-disposition":`attachment; filename=${n}`}),e.pipe(i),setTimeout(function(){fs.unlinkSync(c+n)},5e3)})})})});